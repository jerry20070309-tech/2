<script>
    const CONFIG = { EXCLUDE: ['BTCUSDT','ETHUSDT'], COOLDOWN: 180000 };
    let stats = {}, pinned = new Set(), isRunning = false;
    let priceSnapshots = {}, lastPushTime = {}, lastSnapMin = -1;
    // [代號: FILTER-PARAM] 初始化為你提供的圖中參數
    let FILTER = { SQZ: 0.025, POC: 0.020, SLP: -0.035, DRV: 60, MOM: 0.025 };
    
    // [代號: WSS-ENGINE] TC 核心計數器
    let tradeCounter = {}; 
    let activeWS = new Map();

    function initTradeWS(symbol) {
        if (activeWS.has(symbol)) return;
        
        const ws = new WebSocket(`wss://fapi.binance.com/ws/${symbol.toLowerCase()}@aggTrade`);
        ws.onmessage = (e) => {
            const data = JSON.parse(e.data);
            // 這裡就是 Trade Count 的底層：截獲 aggTrade 封包
            tradeCounter[symbol] = (tradeCounter[symbol] || 0) + 1;
        };
        ws.onclose = () => { activeWS.delete(symbol); };
        ws.onerror = () => { activeWS.delete(symbol); ws.close(); };
        activeWS.set(symbol, ws);
    }

    // [代號: BTN-STRAT] 參數快捷鍵更新
    function applyPreset(mode) {
        const presets = {
            'Sat': { sqz: 8, poc: 5, slp: 5, drv: 110, mom: 5 },
            'Mon': { sqz: 15, poc: 12, slp: 20, drv: 85, mom: 15 },
            'Special': { sqz: 25, poc: 20, slp: 35, drv: 60, mom: 25 } // 依照圖片調校
        };
        const p = presets[mode];
        const keys = ['sqz','poc','slp','drv','mom'];
        ['i_sqz','i_poc','i_slp','i_drv','i_mom'].forEach((id, i) => {
            document.getElementById(id).value = p[keys[i]];
            document.getElementById(id).dispatchEvent(new Event('input'));
        });
    }

    async function scan() {
        if(!isRunning) return;
        try {
            const [tRes, pRes] = await Promise.all([
                fetch('https://fapi.binance.com/fapi/v1/ticker/24hr'), 
                fetch('https://fapi.binance.com/fapi/v1/premiumIndex')
            ]);
            const tickers = await tRes.json();
            
            // 找出前 24 名強勢幣
            const topSymbols = tickers
                .filter(t => t.symbol.endsWith('USDT') && !CONFIG.EXCLUDE.includes(t.symbol))
                .sort((a, b) => Math.abs(parseFloat(b.priceChangePercent)) - Math.abs(parseFloat(a.priceChangePercent)))
                .slice(0, 24)
                .map(x => x.s);

            tickers.forEach(t => {
                const s = t.symbol; if (!s.endsWith('USDT') || CONFIG.EXCLUDE.includes(s)) return;
                
                // [代號: WS-MANAGER] 自動開啟 TC 監控
                if (topSymbols.includes(s) || pinned.has(s)) {
                    initTradeWS(s);
                }

                // 讀取 TC 數據
                const tcVal = tradeCounter[s] || 0;
                tradeCounter[s] = 0; // 讀取後重置，確保下一輪是新的 3 秒統計

                const price = parseFloat(t.lastPrice);
                const avgPrice = parseFloat(t.weightedAvgPrice);
                const high = parseFloat(t.highPrice);
                const low = parseFloat(t.lowPrice);
                const dec = t.lastPrice.split('.')[1]?.length || 2;
                
                const maSqz = (high - low) / avgPrice;
                const drvScore = Math.min(100, (Math.abs(parseFloat(t.priceChangePercent)) / (parseFloat(t.quoteVolume) / 1e8)) * 18);
                const v5m = priceSnapshots[s] ? (price - priceSnapshots[s]) / priceSnapshots[s] : 0;
                
                let score = 0;
                let meets = { 
                    slp: (price - avgPrice) / avgPrice <= FILTER.SLP, 
                    sqz: maSqz <= FILTER.SQZ, 
                    poc: Math.abs(parseFloat(t.priceChangePercent))/100 >= FILTER.POC, 
                    drv: drvScore >= FILTER.DRV, 
                    mom: v5m >= FILTER.MOM 
                };
                
                if (meets.sqz) score += 25;
                if (meets.drv) score += 25;
                if (meets.poc) score += 25;
                if (meets.mom) score += 25;

                stats[s] = { s, price, dec, maSqz, drvScore, score, tc: tcVal, v5m, meets, 
                             rrRatio: (price*(1+maSqz*2)-price)/(price-Math.max(avgPrice, low)||0.001) };
            });
            render();
        } catch (e) { console.error("SCAN_ERROR", e); }
        setTimeout(scan, 3000);
    }
    // ... render 與其他 UI 邏輯 ...
</script>
