<script>
    // [代號: CFG-VAR] 保留原始配置
    const CONFIG = { EXCLUDE: ['BTCUSDT','ETHUSDT'], COOLDOWN: 180000 };
    let stats = {}, pinned = new Set(), isRunning = false;
    let priceSnapshots = {}, lastPushTime = {}, lastSnapMin = -1;
    
    // 初始化為你截圖中的專屬參數 [代號: FILTER-PARAM]
    let FILTER = { SQZ: 0.025, POC: 0.02, SLP: -0.035, DRV: 60, MOM: 0.025 };
    
    // [核心] WebSocket 資源池 - [代號: WSS-ENGINE]
    let tradeCounter = {}, activeWS = new Map();

    function initTradeWS(symbol) {
        if (activeWS.has(symbol)) return;
        try {
            // 指向幣安期貨 aggTrade 流
            const ws = new WebSocket(`wss://fapi.binance.com/ws/${symbol.toLowerCase()}@aggTrade`);
            ws.onmessage = (e) => {
                const data = JSON.parse(e.data);
                // 底層計數邏輯：收到一筆 aggTrade 封包就 +1
                tradeCounter[symbol] = (tradeCounter[symbol] || 0) + 1;
            };
            ws.onclose = () => activeWS.delete(symbol);
            ws.onerror = () => { activeWS.delete(symbol); ws.close(); };
            activeWS.set(symbol, ws);
        } catch(e) { console.error(`WS Error: ${symbol}`); }
    }

    // [代號: PRESET-CTRL] 快捷鍵完全對齊你的需求
    function applyPreset(day) {
        const presets = {
            'Sat': { sqz: 8, poc: 5, slp: 5, drv: 110, mom: 5 }, 
            'Mon': { sqz: 15, poc: 12, slp: 20, drv: 85, mom: 15 },
            'Special': { sqz: 25, poc: 20, slp: 35, drv: 60, mom: 25 } // 圖片參數: 2.5, 2.0, -3.5, 60, 2.5
        };
        const p = presets[day];
        const keys = ['sqz','poc','slp','drv','mom'];
        ['i_sqz','i_poc','i_slp','i_drv','i_mom'].forEach((id, i) => {
            const el = document.getElementById(id);
            if (el) {
                el.value = p[keys[i]];
                el.dispatchEvent(new Event('input'));
            }
        });
    }

    // [代號: DATA-SCAN] 主循環
    async function scan() {
        if(!isRunning) return;
        try {
            const [tRes, pRes] = await Promise.all([
                fetch('https://fapi.binance.com/fapi/v1/ticker/24hr'), 
                fetch('https://fapi.binance.com/fapi/v1/premiumIndex')
            ]);
            const tickers = await tRes.json();
            const now = new Date();

            // 5M 同步邏輯 (保持原樣)
            if (now.getMinutes() % 5 === 0 && now.getMinutes() !== lastSnapMin) {
                lastSnapMin = now.getMinutes();
                tickers.forEach(t => priceSnapshots[t.symbol] = parseFloat(t.lastPrice));
            }

            // [代號: TOP-AUTO] 找出前 24 名強勢幣自動連線 WSS
            const topCandidates = tickers
                .filter(t => t.symbol.endsWith('USDT') && !CONFIG.EXCLUDE.includes(t.symbol))
                .sort((a, b) => Math.abs(parseFloat(b.priceChangePercent)) - Math.abs(parseFloat(a.priceChangePercent)))
                .slice(0, 24)
                .map(x => x.symbol);

            tickers.forEach(t => {
                const s = t.symbol; if (!s.endsWith('USDT') || CONFIG.EXCLUDE.includes(s)) return;
                
                // 自動啟動 WebSocket 監聽 (前 24 名或 Pin 住的)
                if (topCandidates.includes(s) || pinned.has(s)) {
                    initTradeWS(s);
                }

                const price = parseFloat(t.lastPrice), avgPrice = parseFloat(t.weightedAvgPrice);
                const high = parseFloat(t.highPrice), low = parseFloat(t.lowPrice);
                const dec = t.lastPrice.split('.')[1]?.length || 2;
                
                // [代號: TC-READER] 讀取並重置計數器
                const tc3s = tradeCounter[s] || 0; 
                tradeCounter[s] = 0; 

                const maSqz = (high - low) / avgPrice;
                const drvScore = Math.min(100, (Math.abs(parseFloat(t.priceChangePercent)) / (parseFloat(t.quoteVolume) / 1e8)) * 18);
                const v5m = priceSnapshots[s] ? (price - priceSnapshots[s]) / priceSnapshots[s] : 0;
                const gap = (price - avgPrice) / avgPrice;

                let score = 0;
                // [代號: SCORE-SYS] 判定邏輯回歸
                let meets = { 
                    slp: gap <= FILTER.SLP, 
                    sqz: maSqz <= FILTER.SQZ, 
                    poc: Math.abs(parseFloat(t.priceChangePercent))/100 >= FILTER.POC, 
                    drv: drvScore >= FILTER.DRV, 
                    mom: v5m >= FILTER.MOM 
                };
                
                if (meets.sqz) score += 25;
                if (meets.drv) score += 25;
                if (meets.poc) score += 25;
                if (meets.mom) score += 25;

                let slMin = Math.min(price * 0.995, Math.max(avgPrice, low));
                let tpPot = price * (1 + Math.max(0.015, maSqz * 2));

                // 更新數據池
                stats[s] = { s, price, dec, maSqz, drvScore, score, gap, meets, tc: tc3s, v5m, tpPot, slMin, rrRatio: (tpPot - price) / (price - slMin || 0.0001) };

                // 日誌推送
                if (score >= 75 && (!lastPushTime[s] || Date.now() - lastPushTime[s] > CONFIG.COOLDOWN)) {
                    lastPushTime[s] = Date.now();
                    if (typeof addLog === 'function') addLog(s, v5m, score);
                }
            });
            render(); // 呼叫你的原始 render 函數
        } catch (e) { console.error("Scan Error:", e); }
        setTimeout(scan, 3000);
    }
</script>
